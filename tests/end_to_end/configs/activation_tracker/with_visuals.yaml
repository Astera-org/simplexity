name: tracker_with_projections
instance:
  _target_: simplexity.activations.activation_tracker.ActivationTracker
  analyses:
    pca_all_tokens: # <- THIS RETURNS SCALARS AND PROJECTIONS
      instance:
        _target_: simplexity.activations.activation_analyses.PcaAnalysis
        n_components: null
        last_token_only: false
        concat_layers: false
        use_probs_as_weights: true
        variance_thresholds: [0.80, 0.90, 0.95, 0.99]
      visualizations: # <- THIS IS OPTIONAL
        - name: pca_3d_scatter # <- NEW VISUALIZATION
          controls:
            slider: step
            dropdown: layer
            cumulative: false
          data_mapping:
            mappings:
              pc_*: {source: projections, key: pca, component: "*"}
              belief_*: {source: belief_states, component: "*"}
          preprocessing:
            - type: combine_rgb
              input_fields: [belief_*]
              output_fields: [belief_color]
          backend: plotly
          layer:
            geometry:
              type: point
              props: {size: 3}
            aesthetics:
              x: {field: pc_0, type: quantitative, title: "PC 1"}
              y: {field: pc_1, type: quantitative, title: "PC 2"}
              z: {field: pc_2, type: quantitative, title: "PC 3"}
              color:
                field: belief_color
                type: nominal
              opacity: {value: 0.85}
          size: {width: 800, height: 600}
          guides:
            title: "PCA Projection (3D)"
            subtitle: "All tokens, weighted by prefix probability"
        - name: cumulative_explained_variance # <- NEW VISUALIZATION
          controls:
            dropdown: layer
            accumulate_steps: true
            cumulative: false
          data_mapping:
            scalar_series:
              key_template: "{layer}_cumvar_{index}"
              index_field: n_components
              value_field: cumulative_explained_variance
          backend: altair
          layer:
            geometry:
              type: line
              props: {}
            aesthetics:
              x: {field: n_components, type: quantitative, title: "Number of PCA Components"}
              y: {field: cumulative_explained_variance, type: quantitative, title: "Cumulative Explained Variance"}
              color: {field: step, type: nominal, title: Step}
          size: {width: 600, height: 400}
          guides:
            title: "Cumulative Explained Variance by PCA Components"
            subtitle: "All tokens, weighted by probability"

    regression: # <- THIS RETURNS SCALARS AND PROJECTIONS
      instance:
        _target_: simplexity.activations.activation_analyses.LinearRegressionAnalysis
        last_token_only: false
        concat_layers: false
        use_probs_as_weights: true
        # rcond_values: [1e-15, 1e-10, 1e-8, 1e-6, 1e-4, 1e-2]
      visualizations: # <- THIS IS OPTIONAL
        - name: regression_3d # <- NEW VISUALIZATION
          controls:
            slider: step
            dropdown: layer
            cumulative: false
          data_mapping:
            mappings:
              prob_0: {source: projections, key: projected, component: 0}
              prob_1: {source: projections, key: projected, component: 1}
              prob_2: {source: projections, key: projected, component: 2}
              belief_r: {source: belief_states, component: 0}
              belief_g: {source: belief_states, component: 1}
              belief_b: {source: belief_states, component: 2}
          preprocessing:
            - type: combine_rgb
              input_fields: [belief_r, belief_g, belief_b]
              output_fields: [belief_color]
          backend: plotly
          layer:
            geometry:
              type: point
              props: {size: 4}
            aesthetics:
              x: {field: prob_0, type: quantitative, title: "P(State 0)"}
              y: {field: prob_1, type: quantitative, title: "P(State 1)"}
              z: {field: prob_2, type: quantitative, title: "P(State 2)"}
              color:
                field: belief_color
                type: nominal
              opacity: {value: 0.7}
          size: {width: 800, height: 600}
          guides:
            title: "Regression Projection (3D)"
        - name: regression_to_simplex # <- NEW VISUALIZATION
          controls:
            slider: step
            dropdown: layer
            cumulative: false
          data_mapping:
            mappings:
              prob_0: {source: projections, key: projected, component: 0}
              prob_1: {source: projections, key: projected, component: 1}
              prob_2: {source: projections, key: projected, component: 2}
          preprocessing:
            - type: combine_rgb
              input_fields: [prob_0, prob_1, prob_2]
              output_fields: [prediction_color]
            - type: project_to_simplex
              input_fields: [prob_0, prob_1, prob_2]
              output_fields: [simplex_x, simplex_y]
          backend: plotly
          layer:
            geometry:
              type: point
              props: {size: 4}
            aesthetics:
              x: {field: simplex_x, type: quantitative, title: "Simplex X"}
              y: {field: simplex_y, type: quantitative, title: "Simplex Y"}
              color:
                field: prediction_color
                type: nominal
              opacity: {value: 0.7}
          size: {width: 800, height: 600}
          guides:
            title: "Regression Projection (Simplex)"
        - name: ground_truth_simplex
          data_mapping:
            mappings:
              belief_r: {source: belief_states, component: 0}
              belief_g: {source: belief_states, component: 1}
              belief_b: {source: belief_states, component: 2}
          preprocessing:
            - type: combine_rgb
              input_fields: [belief_r, belief_g, belief_b]
              output_fields: [belief_color]
            - type: project_to_simplex
              input_fields: [belief_r, belief_g, belief_b]
              output_fields: [simplex_x, simplex_y]
          backend: plotly
          layer:
            geometry:
              type: point
              props: {size: 4}
            aesthetics:
              x: {field: simplex_x, type: quantitative, title: "Simplex X"}
              y: {field: simplex_y, type: quantitative, title: "Simplex Y"}
              color:
                field: belief_color
                type: nominal
              opacity: {value: 0.7}
          size: {width: 800, height: 600}
          guides:
            title: "Regression Projection (Simplex)"
        # Temporal visualization: RMSE over training steps
        - name: rmse_over_time
          controls:
            accumulate_steps: true
            dropdown: layer  # User can filter by layer in UI
          data_mapping:
            mappings:
              rmse: {source: scalar_pattern, key: "blocks.*.hook_resid_post_rmse"}  # Wildcard expands to all layers
          backend: altair
          layer:
            geometry:
              type: line
              props: {}
            aesthetics:
              x: {field: step, type: quantitative, title: "Training Step"}
              y: {field: rmse, type: quantitative, title: "RMSE"}
              color: {field: layer, type: nominal, title: "Layer"}
              strokeDash: {field: layer, type: nominal}
          size: {width: 800, height: 400}
          guides:
            title: "RMSE Evolution Across Training"
            subtitle: "Tracking model convergence by layer"
    regression_concat: # <- THIS RETURNS SCALARS AND PROJECTIONS
      instance:
        _target_: simplexity.activations.activation_analyses.LinearRegressionAnalysis
        last_token_only: false
        concat_layers: true
        use_probs_as_weights: true
        # rcond_values: [1e-15, 1e-10, 1e-8, 1e-6, 1e-4, 1e-2]
      visualizations: # <- THIS IS OPTIONAL
        - name: regression_to_simplex_concat # <- NEW VISUALIZATION
          controls:
            slider: step
            dropdown: layer
            cumulative: false
          data_mapping:
            mappings:
              prob_0: {source: projections, key: projected, component: 0}
              prob_1: {source: projections, key: projected, component: 1}
              prob_2: {source: projections, key: projected, component: 2}
          preprocessing:
            - type: combine_rgb
              input_fields: [prob_0, prob_1, prob_2]
              output_fields: [prediction_color]
            - type: project_to_simplex
              input_fields: [prob_0, prob_1, prob_2]
              output_fields: [simplex_x, simplex_y]
          backend: plotly
          layer:
            geometry:
              type: point
              props: {size: 4}
            aesthetics:
              x: {field: simplex_x, type: quantitative, title: "Simplex X"}
              y: {field: simplex_y, type: quantitative, title: "Simplex Y"}
              color:
                field: prediction_color
                type: nominal
              opacity: {value: 0.7}
          size: {width: 800, height: 600}
          guides:
            title: "Regression Projection (Simplex)"