on:
  push:
    branches:
      - main
  pull_request:

jobs:
  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: ruff check
        run: uv run --extra dev ruff check --output-format=github || true

      - name: ruff format
        run: uv run --extra dev ruff format --check

      - name: pylint
        run: uv run --extra dev --extra penzai pylint simplexity tests

      - name: pyright
        run: uv run --extra aws --extra dev --extra penzai pyright

  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for diff-cover
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Cache testmon database
        uses: actions/cache@v4
        with:
          path: .testmondata*
          key: testmon-${{ runner.os }}-${{ github.head_ref || github.ref_name }}-${{ hashFiles('simplexity/**/*.py', 'tests/**/*.py') }}
          restore-keys: |
            testmon-${{ runner.os }}-${{ github.head_ref || github.ref_name }}-
            testmon-${{ runner.os }}-main-
            testmon-${{ runner.os }}-

      - name: Run tests with coverage
        run: |
          # Conditional testmon execution:
          # - On PRs: Use --testmon to run only affected tests
          # - On main branch: Use --testmon-noselect to run all tests and update database
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TESTMON_FLAG="--testmon"
            echo "::notice::Running affected tests only (PR mode)"
          else
            TESTMON_FLAG="--testmon-noselect"
            echo "::notice::Running full test suite (main branch mode)"
          fi
          
          # Run tests with coverage tracking (no threshold enforcement)
          # Coverage is tracked but won't fail - new code in PRs is checked via diff-cover
          # TODO: Enable strict overall coverage enforcement once coverage improves
          # Note: --cov-fail-under=0 is explicit but redundant since pyproject.toml doesn't set a threshold
          # Exclude end-to-end tests - they run in a separate workflow
          uv run --extra aws --extra dev --extra cuda --extra penzai pytest \
            --capture=no \
            --verbose \
            --cov-fail-under=0 \
            --ignore=tests/end_to_end \
            $TESTMON_FLAG
          
          # Verify coverage.xml was generated (required for diff-cover and Codecov)
          # This is ensured by --cov-report=xml in pyproject.toml, but we verify for clarity
          if [ ! -f coverage.xml ]; then
            echo "::error::coverage.xml not found - coverage reporting may have failed"
            exit 1
          fi

      - name: Check coverage for new code (PRs only)
        if: github.event_name == 'pull_request'
        run: |
          # Get the base branch (usually main)
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          echo "Checking coverage for new code against base branch: ${BASE_BRANCH}"
          # Run diff-cover to check only new/changed code
          # Fail if new code coverage is below 80%
          # Note: diff-cover only needs --extra dev (tests need all extras for integration testing)
          if uv run --extra dev diff-cover coverage.xml \
            --compare-branch=origin/${BASE_BRANCH} \
            --fail-under=80 \
            --markdown-report diff-coverage-report.md; then
            echo "::notice::New code coverage check passed (80% threshold)"
          else
            echo "::error::New code coverage is below 80% threshold"
            exit 1
          fi
        continue-on-error: false

      - name: Upload diff coverage report
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'diff-coverage-report.md';
            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              fs.appendFileSync(
                process.env.GITHUB_STEP_SUMMARY,
                `## Diff Coverage Report\n\n${report}\n`
              );
            }

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: Astera-org/simplexity
          verbose: true
          files: ./coverage.xml
          fail_ci_if_error: false