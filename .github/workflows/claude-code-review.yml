# See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
# or https://docs.anthropic.com/en/docs/claude-code/sdk#command-line for available options

name: Claude Code Review

on:
  workflow_run:
    workflows: ["simplexity"]
    types:
      - completed

jobs:
  claude-review:
    # Only run if the triggering workflow succeeded and it was triggered by a pull_request
    if: |
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 1

      - name: Check if PR is draft
        id: check-draft
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const workflowRun = context.payload.workflow_run;
              
              // Find the PR associated with this workflow run
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${workflowRun.head_branch}`,
              });
              
              if (prs.data.length === 0) {
                core.info('No open PR found - skipping Claude review');
                core.setFailed('No PR found');
                return;
              }
              
              const pr = prs.data[0];
              const isDraft = pr.draft === true;
              
              if (isDraft) {
                core.info(`PR #${pr.number} is a draft - skipping Claude review`);
                core.setFailed('PR is a draft');
              } else {
                core.info(`PR #${pr.number} is ready for review - proceeding with Claude review`);
              }
            } catch (error) {
              core.warning(`Error checking PR status: ${error.message}`);
              core.setFailed('Error checking PR status');
            }

      - name: Run Claude Code Review
        if: steps.check-draft.outcome == 'success'
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Please review this pull request for:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage
            using the repository's CLAUDE.md for guidance on style and conventions.

            IMPORTANT: You must create a proper GitHub review with inline comments on specific lines (not just a single comment).
            
            Review Process:
            1. Use `gh pr view --json number,headRefName,baseRefName` to get the PR number
            2. Use `gh pr diff` to see all changes - this shows the unified diff format
            3. For each issue you find:
               - Note the file path and the line number in the diff (the position after the @@ line)
               - The position is the line number where the change appears in the unified diff (count from the @@ hunk header)
            4. Create ONE review with all inline comments using the GitHub API
            
            To create a review with inline comments, use this format:
            
            ```bash
            PR_NUM=$(gh pr view --json number -q .number)
            gh api repos/:owner/:repo/pulls/$PR_NUM/reviews \
              -X POST \
              -f event=REQUEST_CHANGES \
              -f body="Overall review summary" \
              -f comments='[
                {
                  "path": "simplexity/file.py",
                  "position": 15,
                  "body": "Issue description and suggested fix"
                },
                {
                  "path": "tests/test_file.py", 
                  "position": 42,
                  "body": "Another issue description"
                }
              ]'
            ```
            
            Important:
            - `event` must be one of: APPROVE, REQUEST_CHANGES, or COMMENT
            - `position` is the line number in the unified diff (the number after @@ in the diff output)
            - Count lines in the diff starting from the hunk header (the @@ line)
            - Include ALL inline comments in a single API call
            - If no issues found: use `event=APPROVE` with body "PR approved, no improvements needed" and empty comments array
            - If issues found: use `event=REQUEST_CHANGES` with inline comments for each specific issue
            
            For each inline comment, provide:
            - Clear description of the issue
            - Reference to the specific code
            - Suggested fix (preferably as a code block)
            
            Be concise and actionable. Each inline comment should be resolvable independently.
          
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh pr review:*),Bash(gh api:*)"'

