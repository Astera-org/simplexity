# GitHub Copilot Code Review
#
# This workflow requests a review from GitHub Copilot only after all checks pass.
#
# IMPORTANT: To use this workflow, you must DISABLE the automatic Copilot review
# in your repository ruleset (Settings > Rules > Rulesets). Otherwise, Copilot
# will be added as a reviewer immediately when the PR is created, defeating the
# purpose of this workflow.
#
# This workflow:
# 1. Triggers after the "simplexity" workflow completes successfully
# 2. Finds the associated PR
# 3. Checks if Copilot is already a reviewer (to avoid duplicates)
# 4. Requests Copilot as a reviewer if not already present

name: Copilot Code Review

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["simplexity"]
    types:
      - completed
  pull_request:
    types:
      - ready_for_review
    branches:
      - main

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      checks: read
      actions: read

    # Only run if:
    # 1. Manually triggered (workflow_dispatch)
    # 2. PR event targeting main
    # 3. Workflow_run event where head_branch is main (push to main)
    # 4. Workflow_run event where associated PR targets main
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.head_branch == 'main') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.event == 'pull_request' && github.base_ref == 'main')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.event.pull_request.head.sha }}
          fetch-depth: 1

      - name: Check PR status and checks
        id: check-status
        uses: actions/github-script@v7
        with:
          script: |
            let pr;

            if (context.eventName === 'workflow_run') {
              // Triggered by workflow_run - check if workflow succeeded
              const workflowRun = context.payload.workflow_run;
              if (workflowRun.event !== 'pull_request' || workflowRun.conclusion !== 'success') {
                core.setFailed('Workflow did not succeed or was not triggered by PR');
                return;
              }
              
              // Find the PR associated with this workflow run
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${workflowRun.head_branch}`,
              });
              
              if (prs.data.length === 0) {
                core.setFailed('No open PR found');
                return;
              }
              
              pr = prs.data[0];
            } else {
              // Triggered by ready_for_review event
              pr = context.payload.pull_request;
              
              // Check if the simplexity workflow has completed successfully
              // List all workflow runs for this commit
              const workflowRuns = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head_sha: pr.head.sha,
              });
              
              // Find the simplexity workflow run
              const simplexityRun = workflowRuns.data.workflow_runs.find(
                run => run.name === 'simplexity' || run.path === '.github/workflows/simplexity.yaml'
              );
              
              if (!simplexityRun) {
                core.info('Simplexity workflow not found for this commit - skipping review');
                core.setFailed('Checks not found');
                return;
              }
              
              if (simplexityRun.status !== 'completed' || simplexityRun.conclusion !== 'success') {
                core.info(`Simplexity workflow status: ${simplexityRun.status}, conclusion: ${simplexityRun.conclusion} - skipping review`);
                core.setFailed('Checks not passing');
                return;
              }
            }

            // Skip if PR is a draft
            if (pr.draft === true) {
              core.info(`PR #${pr.number} is a draft - skipping Copilot review`);
              core.setFailed('PR is a draft');
              return;
            }

            core.info(`Processing PR #${pr.number} - all checks have passed`);

      - name: Check and request Copilot review
        if: steps.check-status.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            let pr;

            if (context.eventName === 'workflow_run') {
              const workflowRun = context.payload.workflow_run;
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${workflowRun.head_branch}`,
              });
              pr = prs.data[0];
            } else {
              pr = context.payload.pull_request;
            }

            const prNumber = pr.number;

            // Get current reviewers to check if Copilot is already a reviewer
            const reviews = await github.rest.pulls.listRequestedReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            // Check if Copilot is already a requested reviewer
            const existingReviewers = [
              ...(reviews.data.users || []).map(u => u.login.toLowerCase()),
              ...(reviews.data.teams || []).map(t => t.slug.toLowerCase()),
            ];

            const copilotIdentifiers = ['github-copilot', 'copilot', 'github-copilot[bot]'];
            const hasCopilot = existingReviewers.some(r => 
              copilotIdentifiers.some(id => r.includes(id))
            );

            if (hasCopilot) {
              core.info('GitHub Copilot is already a requested reviewer for this PR - skipping');
              return;
            }

            // Try to request Copilot as a reviewer
            core.info(`Requesting Copilot review for PR #${prNumber}...`);

            try {
              // Note: The GitHub API may not directly support requesting Copilot as a reviewer
              // since it's an app, not a user. This is a best-effort attempt.
              // You may need to configure this differently based on your organization's setup.
              
              // Try requesting with empty arrays first (some setups might handle this)
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                reviewers: [],
                team_reviewers: [],
              });
              
              core.info(`Review request API call completed for PR #${prNumber}`);
              core.warning('Note: If Copilot was not added, it may need to be requested differently.');
              core.info('You may need to manually request a review from GitHub Copilot,');
              core.info('or configure Copilot reviews through repository settings.');
              
            } catch (error) {
              core.warning(`Could not request Copilot review via API: ${error.message}`);
              core.info('This is expected if Copilot needs to be requested through a different method.');
              core.info('You may need to:');
              core.info('1. Manually request a review from GitHub Copilot in the PR');
              core.info('2. Check repository settings for Copilot review configuration');
              core.info('3. Verify Copilot is installed and available for this repository');
            }
