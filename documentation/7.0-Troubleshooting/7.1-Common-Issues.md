# 7.1. Common Issues and Troubleshooting

This section lists some common issues encountered when working with the Simplexity framework and provides guidance on how to troubleshoot them.

## 1. Configuration Errors (Hydra)

*   **Issue:** Errors like `OmegaConfBaseException`, `MissingMandatoryValue`, `ConfigKeyError`, `InterpolationKeyError` during script startup.
*   **Cause:** Problems with YAML configuration files or command-line overrides.
    *   Incorrect path in `defaults` list.
    *   Typos in parameter names or group names.
    *   A required parameter is not set and has no default.
    *   An interpolated variable (e.g., `${...}`) cannot be resolved.
    *   Incorrect `_target_` path (class/function cannot be found).
*   **Troubleshooting:**
    1.  **Check YAML Syntax:** Ensure all YAML files are correctly formatted. Use a YAML linter.
    2.  **Verify Paths and Names:** Double-check all filenames, config group names, and parameter keys in your `experiment.yaml` and any included files.
    3.  **Inspect Full Config:** Run `python simplexity/run_experiment.py --cfg job` (or your specific script) to print the fully resolved configuration. This can help identify where a misconfiguration is occurring or what the final structure looks like.
    4.  **Check `_target_`:** Ensure the Python paths in `_target_` fields are correct and point to existing, importable classes or functions.
    5.  **Parameter Mismatches:** If `_target_` points to a class/function, ensure the parameters provided in the YAML match its `__init__` or function signature. Hydra will often complain about unexpected or missing arguments.

## 2. JAX / Equinox / Penzai Errors

*   **Issue:** Errors related to JAX transformations (`jax.jit`, `jax.grad`, `jax.vmap`), array shapes, data types, or specific Equinox/Penzai API usage.
    *   `TypeError` or `ValueError` from within JIT-compiled functions.
    *   Shape mismatches in array operations.
    *   `ConcretizationTypeError` (trying to use a JAX tracer abstractly where a concrete value is needed).
*   **Troubleshooting:**
    1.  **Simplify:** If an error occurs in a complex JIT-compiled function, try to isolate the problematic part and test it outside the JIT compilation first.
    2.  **Print Shapes and DTypes:** Use `print(array.shape, array.dtype)` extensively before and inside JAX operations to verify assumptions.
    3.  **Equinox `eqx.debug_summary(model)`:** Can be useful to understand the structure of your Equinox model, including static and dynamic parts.
    4.  **Penzai Visualization:** Penzai often has good visualization tools for its structures. Use them if your error involves Penzai objects.
    5.  **Refer to JAX/Equinox/Penzai Docs:** These libraries have excellent documentation. Consult them for API usage and common pitfalls.
    6.  **Disable JIT:** Temporarily remove `@eqx.filter_jit` or `@jax.jit` decorators to get more precise Python stack traces, but be aware this will significantly slow down execution and might change behavior for some errors (like `ConcretizationTypeError`).

## 3. Data Generation or Batching Issues

*   **Issue:** Model receives data of unexpected shape, type, or content.
*   **Cause:** Problems in the `GenerativeProcess` implementation or the `generate_data_batch` function.
*   **Troubleshooting:**
    1.  **Inspect `generate_data_batch`:** Add print statements inside this function (in `train_equinox_model.py` or `evaluate_equinox_model.py`) to check the shapes and content of `obs`, `inputs`, and `labels` before they are returned.
    2.  **Test `GenerativeProcess` Independently:** Instantiate your data generator and call its `generate()` method directly in a separate script or notebook to verify its output.
    3.  **Check `vocab_size`:** Ensure `vocab_size` consistency between the data generator and the model, especially for one-hot encoding and output layers.

## 4. CUDA / GPU Issues

*   **Issue:** JAX cannot find or use the GPU; CUDA-related errors during startup or execution.
*   **Cause:** Incorrect NVIDIA driver, CUDA toolkit version, or JAX installation for GPU support.
*   **Troubleshooting:**
    1.  **Verify JAX GPU Installation:** Check the official JAX documentation for installing with CUDA support. The project specifies `jax[cuda12_pip]`, so ensure your environment matches.
    2.  **Run JAX GPU check:**
        ```python
        import jax
        print(jax.devices())
        ```
        This should list your GPU(s).
    3.  **Check `nvidia-smi`:** Ensure your NVIDIA drivers are running and the CUDA version reported by `nvidia-smi` is compatible with your JAX installation.
    4.  **Environment Variables:** Sometimes `LD_LIBRARY_PATH` or `XLA_PYTHON_CLIENT_MEM_FRACTION` might need adjustment, but usually, a correct JAX install handles this.

## 5. MLflow Issues (if using `MLFlowLogger`)

*   **Issue:** Cannot connect to MLflow server; metrics/params not appearing in MLflow UI.
*   **Cause:** MLflow server not running, incorrect `tracking_uri`, network issues, or errors within `MLFlowLogger`.
*   **Troubleshooting:**
    1.  **Check MLflow Server:** Ensure your MLflow tracking server is running and accessible at the configured `tracking_uri`.
    2.  **Verify `tracking_uri`:** Double-check the URI in your `logging/mlflow_logger.yaml` or as overridden.
    3.  **MLflow Client Logs:** Look for any error messages printed by the `mlflow` client library in the experiment's `stdout`/`stderr`.
    4.  **Permissions:** If logging to a remote server or shared file store, ensure you have write permissions.

## 6. Persistence (Checkpointing) Issues

*   **Issue:** Models not saving or loading correctly; `FileNotFoundError` when trying to load.
*   **Cause:** Incorrect paths in persistence config, issues with serialization (e.g., trying to save non-serializable objects with Equinox/Penzai methods), or file system permission problems.
*   **Troubleshooting:**
    1.  **Verify Paths:** Check `directory` and `filename` in your `persistence` configuration. Ensure the directory exists and is writable/readable.
    2.  **Serialization Compatibility:** Ensure the method of saving (e.g., `eqx.tree_serialise_leaves`) is compatible with the model structure. Some complex Python objects within an Equinox model might not be serializable by default unless marked `static=True` or handled customly.
    3.  **Step Number:** When loading, ensure the `step` number corresponds to an actual saved checkpoint file.

## 7. Output Files Not Found

*   **Issue:** Can't find logs, configs, or checkpoints after a run.
*   **Cause:** Misunderstanding Hydra's output directory structure.
*   **Troubleshooting:**
    1.  **Identify Run Directory:** Recall that Hydra creates output directories like `outputs/<date>/<time>/` or `multirun/<date>/<time>/<trial_id>/` relative to where the script was run.
    2.  Check `stdout` for messages from Hydra indicating the output path for the current run.
    3.  If paths in logger or persister configs are absolute, check those absolute locations instead of within the Hydra output directory.

When in doubt, adding print statements, simplifying the problem, and consulting the documentation of the specific libraries involved (Hydra, JAX, Equinox, Optax, Penzai, MLflow) are key troubleshooting strategies. 