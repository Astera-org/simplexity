# 4.5. Persistence (Saving/Loading Models)

Model persistence is crucial for saving trained model checkpoints and for resuming training or loading models for inference. The Simplexity framework provides a system for this through the `ModelPersister` interface and its implementations.

## Core Interface: `ModelPersister`

All model persistence functionalities are based on the abstract base class `simplexity.persistence.model_persister.ModelPersister`. This class is an `equinox.Module` and defines the contract for saving and loading model weights.

Key methods:
*   **`save_weights(self, model: PredictiveModel, step: int = 0) -> None`:**
    *   An abstract method that concrete persisters implement to save the weights (and other serializable state) of the provided `model`.
    *   The `step` argument indicates the training step at which the checkpoint is being saved, allowing for multiple versions of the model to be stored.

*   **`load_weights(self, model: PredictiveModel, step: int = 0) -> PredictiveModel`:**
    *   An abstract method to load weights from a previously saved checkpoint (identified by `step`) into the provided `model` instance.
    *   It returns the `model` with the loaded weights. This is important as Equinox models are often immutable, so loading might return a new model instance.

*   **Context Manager Protocol (`__enter__`, `__exit__`, `cleanup`):**
    *   `ModelPersister` can be used as a context manager (`with ... as persister:`).
    *   The `__exit__` method calls `cleanup()`, which can be overridden by subclasses to perform any necessary resource cleanup (e.g., closing connections, cleaning temporary files).

## Concrete Persister Implementations

The framework includes several persister implementations:

1.  **`simplexity.persistence.local_equinox_persister.LocalEquinoxPersister`:**
    *   Saves and loads Equinox model weights to/from the local filesystem.
    *   Likely uses `equinox.tree_serialise_leaves()` and `equinox.tree_deserialise_leaves()` for serialization.
    *   Configuration (`simplexity/configs/persistence/local_persister.yaml` often defaults to this or similar for Equinox models):
        ```yaml
        # Example for local Equinox persister config
        _target_: simplexity.configs.persistence.config.LocalEquinoxPersisterConfig # Dataclass for config
        # instance._target_ would be "simplexity.persistence.local_equinox_persister.LocalEquinoxPersister"
        directory: "./model_checkpoints" # Directory to save checkpoints
        filename: "model_step_{step}.eqx" # Filename pattern, {step} is replaced
        ```

2.  **`simplexity.persistence.local_penzai_persister.LocalPenzaiPersister`:**
    *   Saves and loads Penzai models/objects to/from the local filesystem.
    *   Uses Penzai's specific serialization mechanisms (e.g., `pz.pz_computation_to_json_str` or similar if saving entire computations, or methods for saving Penzai trees).
    *   Configuration would be similar, pointing to `LocalPenzaiPersister` and its config dataclass.

3.  **`simplexity.persistence.s3_persister.S3Persister`:**
    *   Saves and loads model checkpoints to/from an AWS S3 bucket.
    *   Requires AWS credentials and `boto3` to be configured.
    *   Configuration (`simplexity/configs/persistence/s3_persister.yaml`):
        ```yaml
        _target_: simplexity.configs.persistence.config.S3PersisterConfig
        # instance._target_ would be "simplexity.persistence.s3_persister.S3Persister.from_config"
        bucket_name: "my-simplexity-checkpoints"
        directory: "experiment_x/run_y" # Path within the bucket
        filename: "model_step_{step}.eqx" # Or appropriate extension
        # Potentially other S3 related configs like region, endpoint_url for MinIO etc.
        ```

4.  **`simplexity.persistence.local_persister.py`**: This appears to be a minimal file and might serve as a very basic default or an alias in the configuration structure, possibly pointing to `LocalEquinoxPersister` by default through the config system.

## Configuration and Usage

*   The desired persister is selected in the main experiment configuration (e.g., `experiment.yaml`) via Hydra's composition:
    ```yaml
    defaults:
      # ...
      - persistence: local_persister # or s3_persister
      # ...
    ```
*   The `run_experiment.py` script instantiates the persister using `simplexity.utils.hydra.typed_instantiate` based on the `persistence.instance` configuration.
*   The persister is used as a context manager:
    ```python
    with typed_instantiate(cfg.persistence.instance, ModelPersister) as persister:
        if cfg.predictive_model.load_checkpoint_step:
            model = persister.load_weights(model, cfg.predictive_model.load_checkpoint_step)
        # ... then pass persister to the train function ...
    ```
*   Inside the `train` function, `persister.save_weights(model, step)` is called at checkpointing intervals.

## For Experimentalists

*   **Choosing a Persister:** Change the `persistence` default in `experiment.yaml`.
*   **Configuring Persister Details:** Modify the specific YAML file for the chosen persister (e.g., `simplexity/configs/persistence/local_persister.yaml` to change save `directory` or `filename` format) or override via command line:
    ```bash
    python simplexity/run_experiment.py persistence.instance.directory="/data/my_checkpoints"
    ```
*   **Loading a Checkpoint:** Set `predictive_model.load_checkpoint_step=<step_number>` in your configuration (e.g., `experiment.yaml` or via command line) to resume training or load a specific model version.
    ```bash
    python simplexity/run_experiment.py predictive_model.load_checkpoint_step=10000
    ```

## For LLM Agents

*   Agents can manage model persistence by modifying the `persistence` section of the Hydra configuration, selecting the backend and its parameters (directory, bucket name, filenames).
*   To load a specific checkpoint, the agent needs to set `predictive_model.load_checkpoint_step` to the desired step number.
*   The path to persister parameters is typically `persistence.instance.<parameter_name>`. 